<!-- Thread header -->
<div class="w-full h-full flex flex-col">
  <div
    class="flex justify-between px-[40px] py-[32px] items-center shadow-[0px_2px_10px_0px_#00000014] rounded-t-[32px]"
  >
    <div class="flex gap-1 items-center">
      <p class="text-xl font-bold mr-1">Thread</p>
      <p
        class="text-sm font-normal text-[#797EF3]"
        *ngIf="group$ | async as group"
      >
        # {{ group.name }}
      </p>
    </div>
    <button
      class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-[#ECEEFE] hover:text-[#535AF1] group"
      (click)="onClose()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 h-6 text-black group-hover:text-[#535AF1]"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
  </div>

  <!-- Thread message -->
  <div class="flex items-start my-2 gap-[15px] px-[40px] pt-[10px]">
    <ng-container *ngIf="originalMessage$ | async as msg">
      <ng-container *ngIf="participantsMap[msg.sender] as user">
        <img
          [src]="user.avatar"
          class="w-[70px] h-[70px] rounded-full"
          [alt]="user.name"
        />
        <div class="flex flex-col max-w-[80%] gap-1">
          <div class="flex items-center gap-5">
            <span class="font-bold text-base"> {{ user.name }}</span>
            <span class="text-[#686868] font-normal text-xs">
              {{ msg.createdAt?.toDate() | date : "HH:mm" }} Uhr</span
            >
          </div>
          <div
            class="p-[15px] w-max text-base transition-colors duration-200 bg-[#ECEEFE] text-black rounded-b-[30px] rounded-tr-[30px] group-hover:bg-white"
          >
            {{ msg.text }}
          </div>
        </div>
      </ng-container>
    </ng-container>
  </div>

  <!-- Separator -->
  <ng-container *ngIf="threadMessages$ | async as replies">
    <div *ngIf="replies.length > 1" class="px-[40px] py-4">
      <div class="flex items-center">
        <span class="text-base text-[#ADB0D9] whitespace-nowrap">
          {{ replies.length }} Antworten
        </span>
        <div class="flex-grow h-px bg-[#ADB0D9] ml-5"></div>
      </div>
    </div>
    <div *ngIf="replies.length === 1" class="px-[40px] py-4">
      <div class="flex items-center">
        <span class="text-base text-[#ADB0D9] whitespace-nowrap">
          {{ replies.length }} Antwort
        </span>
        <div class="flex-grow h-px bg-[#ADB0D9] ml-5"></div>
      </div>
    </div>
  </ng-container>

  <!-- Answers -->
  <div class="space-y-3 overflow-auto h-[65vh]">
    <ng-container *ngFor="let msg of threadMessages$ | async">
      <ng-container *ngIf="participantsMap[msg.sender] as user">
        <div
          class="relative group flex my-4 gap-[30px] px-[45px] py-4 transition-colors duration-200 hover:bg-[#ECEEFE]"
          [ngClass]="{
            'justify-end': msg.sender === currentUserUid,
            'items-start': msg.sender !== currentUserUid
          }"
        >
          <!-- EDIT MODE -->
          <ng-container *ngIf="editingMsgId === msg.id; else threadReadOnly">
            <div
              class="flex flex-col w-full max-w-[80%] bg-white border border-[#ECEFFE] rounded-[24px] px-[20px] py-[16px]"
              [ngClass]="{
                'self-end': msg.sender === currentUserUid,
                'self-start': msg.sender !== currentUserUid
              }"
            >
              <textarea
                #editInput
                class="w-full resize-none bg-transparent mb-2 text-gray-800 placeholder-gray-500 text-base leading-relaxed outline-none"
                [(ngModel)]="editText"
                placeholder="{{ msg.text }}"
                rows="1"
                (input)="autoGrow(editInput)"
              ></textarea>
              <div class="flex items-center justify-between mt-2">
                <div class="picker-container relative inline-block">
                  <button
                    class="p-2 hover:bg-gray-100 rounded-full"
                    (click)="
                      toggleMessagePicker(msg.id); $event.stopPropagation()
                    "
                  >
                    <img
                      src="../../../assets/img/icons/add_reaction.png"
                      class="w-6 h-6"
                    />
                  </button>
                  <div
                    *ngIf="messagePicker[msg.id]"
                    class="absolute bottom-full z-50"
                  >
                    <emoji-picker
                      (emoji-click)="
                        addEmojiToEdit($event.detail.unicode!);
                        messagePicker[msg.id] = false
                      "
                    ></emoji-picker>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button
                    class="px-4 py-2 border border-[#797EF3] text-[#797EF3] rounded-full hover:bg-[#F5F4FF]"
                    (click)="cancelEdit()"
                  >
                    Abbrechen
                  </button>
                  <button
                    class="px-4 py-2 bg-[#797EF3] text-white rounded-full hover:bg-[#5F5CD6]"
                    (click)="saveEdit(msg)"
                  >
                    Speichern
                  </button>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- READ-ONLY MODE -->
          <ng-template #threadReadOnly>
            <!-- avatar on left for others -->
            <img
              *ngIf="msg.sender !== currentUserUid"
              [src]="user.avatar"
              [alt]="user.name"
              class="w-[70px] h-[70px] rounded-full"
            />

            <div
              class="picker-container flex flex-col max-w-[80%] gap-1"
              [ngClass]="{
                'items-end': msg.sender === currentUserUid,
                'items-start': msg.sender !== currentUserUid
              }"
            >
              <!-- name & time -->
              <div
                class="flex items-center gap-5"
                [ngClass]="{
                  'flex-row-reverse': msg.sender === currentUserUid
                }"
              >
                <span class="font-bold text-base">
                  {{ user.name }}
                </span>
                <span class="text-[#686868] font-normal text-xs">
                  {{ msg.createdAt?.toDate() | date : "HH:mm" }} Uhr
                </span>
              </div>

              <!-- message bubble -->
              <div
                class="p-[15px] text-base transition-colors duration-200"
                [ngClass]="
                  msg.sender === currentUserUid
                    ? 'bg-[#797EF3] text-white rounded-b-[30px] rounded-tl-[30px]'
                    : 'bg-[#ECEEFE] text-black rounded-b-[30px] rounded-tr-[30px] group-hover:bg-white'
                "
              >
                {{ msg.text }}
              </div>

              <!-- reactions bar -->
              <div
                class="flex items-center mt-1 gap-1"
                [ngClass]="{
                  'pr-0 flex-row-reverse justify-end':
                    msg.sender === currentUserUid,
                  'pl-0 justify-start': msg.sender !== currentUserUid
                }"
              >
                <div class="picker-container relative inline-block">
                  <button
                    class="flex-none p-2 hover:bg-gray-100 rounded-full"
                    (click)="toggleMessagePicker(msg.id)"
                  >
                    <img
                      src="../../../assets/img/icons/add_reaction.png"
                      class="w-6 h-6"
                    />
                  </button>
                  <div
                    *ngIf="messagePicker[msg.id]"
                    class="absolute bottom-full z-50"
                    [ngClass]="
                      msg.sender === currentUserUid ? 'right-0' : 'left-0'
                    "
                  >
                    <emoji-picker
                      (emoji-click)="
                        onReactionClick(msg, $event.detail.unicode!);
                        messagePicker[msg.id] = false
                      "
                    ></emoji-picker>
                  </div>
                </div>

                <div
                  class="flex flex-1 flex-wrap items-center gap-1"
                  [ngClass]="{
                    'space-x-reverse': msg.sender === currentUserUid
                  }"
                >
                  <ng-container *ngFor="let r of displayedReactions(msg)">
                    <div class="relative flex-shrink-0">
                      <span
                        class="peer z-10 whitespace-nowrap px-2 py-1 text-sm bg-gray-200 rounded-full cursor-pointer hover:bg-gray-400"
                        (click)="onReactionClick(msg, r.emoji)"
                      >
                        {{ r.emoji }} {{ r.count }}
                      </span>
                      <div
                        class="invisible opacity-0 peer-hover:visible peer-hover:opacity-100 absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-gray-800 text-white text-xs rounded py-2 px-3 pointer-events-none"
                      >
                        <div class="mb-1 flex justify-center">
                          {{ r.emoji }}
                        </div>
                        <ng-container
                          *ngIf="getReactionUserNames(msg, r.emoji) as names"
                        >
                          <div *ngIf="names.length === 1">
                            {{ names[0] }} hat reagiert
                          </div>
                          <div *ngIf="names.length === 2">
                            {{ names[0] }} und {{ names[1] }} haben reagiert
                          </div>
                          <div *ngIf="names.length > 2">
                            {{ names[0] }}, {{ names[1] }} und andere
                            {{ names.length - 2 }} haben reagiert
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>

                  <button
                    *ngIf="extraCount(msg) > 0"
                    class="px-2 py-1 text-sm bg-gray-200 rounded-full hover:bg-gray-300"
                    (click)="toggleReactions(msg.id)"
                  >
                    {{
                      isExpanded(msg.id)
                        ? "Show less"
                        : "+" + extraCount(msg) + " more"
                    }}
                  </button>
                </div>
              </div>

              <!-- hover menus -->
              <div
                *ngIf="msg.sender !== currentUserUid"
                class="hidden group-hover:flex gap-1 absolute -top-4 right-[45px] px-[15px] py-[3px] bg-white border border-[#ADB0D9] rounded-l-[25px] rounded-tr-[25px]"
              >
                <button (click)="onReactionClick(msg, '‚úîÔ∏è')">‚úîÔ∏è</button>
                <button (click)="onReactionClick(msg, 'üëç')">üëç</button>
                <button (click)="toggleMessagePicker(msg.id)">üòÄ</button>
              </div>
              <div
                *ngIf="msg.sender === currentUserUid"
                class="hidden group-hover:flex gap-1 absolute -top-4 left-[45px] px-[15px] py-[3px] bg-white border border-[#ADB0D9] rounded-l-[25px] rounded-tr-[25px]"
              >
                <button (click)="onReactionClick(msg, '‚úîÔ∏è')">‚úîÔ∏è</button>
                <button (click)="onReactionClick(msg, 'üëç')">üëç</button>
                <button (click)="toggleMessagePicker(msg.id)">üòÄ</button>
                <button (click)="startEdit(msg)">Edit</button>
              </div>
            </div>
          </ng-template>

          <!-- avatar on right for own messages -->
          <img
            *ngIf="msg.sender === currentUserUid"
            [src]="user.avatar"
            [alt]="user.name"
            class="w-[70px] h-[70px] rounded-full"
          />
        </div>
      </ng-container>
    </ng-container>
  </div>

  <!-- Input Field -->
  <div class="px-[35px] pb-[35px] pt-[15px] bg-transparent">
    <div
      class="flex flex-col p-5 border border-[#ADB0D9] rounded-[20px] gap-[20px]"
    >
      <!-- Textarea at top -->
      <textarea
        [(ngModel)]="threadText"
        name="threadText"
        placeholder="Antworten..."
        class="w-full resize-none border-none focus:outline-none text-lg placeholder-[#686868] bg-transparent pr-[30px]"
      ></textarea>

      <!-- Icon row at bottom -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-1">
          <div class="relative">
            <div class="relative emoji-input-container">
              <button
                #emojiBtn
                class="p-2 rounded-full transition-colors"
                [ngClass]="{ 'bg-[#F0EDFF]': isEmojiHovered }"
                (mouseenter)="isEmojiHovered = true"
                (mouseleave)="isEmojiHovered = false"
                (click)="toggleEmojiPicker()"
              >
                <img
                  [src]="
                    isEmojiHovered
                      ? '../../../assets/img/icons/sentiment_satisfied_purple.png'
                      : '../../../assets/img/icons/sentiment_satisfied.png'
                  "
                  class="w-6 h-6"
                  alt="emoji"
                />
              </button>
              <div
                *ngIf="showEmojiPicker"
                #picker
                class="absolute z-50 bottom-10 left-0"
              >
                <emoji-picker (emoji-click)="addEmoji($event)"></emoji-picker>
              </div>
            </div>
          </div>
          <button
            class="p-2 rounded-full transition-colors"
            [ngClass]="{ 'bg-[#F0EDFF]': isAttachHovered }"
            (mouseenter)="isAttachHovered = true"
            (mouseleave)="isAttachHovered = false"
          >
            <img
              [src]="
                isAttachHovered
                  ? '../../../assets/img/icons/alternate_email_purple.png'
                  : '../../../assets/img/icons/alternate_email.png'
              "
              class="w-6 h-6"
              alt="attachment"
            />
          </button>
        </div>
        <button
          (click)="sendThread()"
          [disabled]="!threadText.trim()"
          class="p-2 disabled:opacity-0 hover:opacity-70"
        >
          <img
            src="../../../assets/img/icons/send.png"
            class="w-6 h-6"
            alt="send"
          />
        </button>
      </div>
    </div>
  </div>
</div>
