<div class="w-full h-full flex flex-col">
  <div
    class="w-full flex justify-between px-[45px] pt-[32px] pb-[20px] rounded-t-[32px] shadow-[0px_2px_10px_0px_#00000014] items-center"
  >
    <!-- if the open chat is a group-->
    <div *ngIf="!chatPartner" class="flex gap-2">
      <div class="flex gap-2 items-center">
        <img src="../../../assets/img/icons/tag.png" alt="" />
        <p class="text-xl font-bold">Entwicklerteam</p>
      </div>
      <img src="../../../assets/img/icons/arrow_down.png" alt="" />
    </div>

    <!-- if the open chat is a user -->
    <div class="flex items-center gap-4 px-2 pt-px rounded-[35px]">
      <div class="relative">
        <img
          *ngIf="chatPartner"
          [src]="chatPartner.avatar"
          alt="{{ chatPartner.name }}"
          class="w-[45px] h-[45px] rounded-full"
        />
        <div
          *ngIf="chatPartner"
          class="absolute bottom-0 right-[-2px] w-4 h-4 bg-[#92C83E] rounded-full border-2 border-white"
        ></div>
      </div>
      <p *ngIf="chatPartner" class="text-2xl font-bold">
        {{ chatPartner.name }}
      </p>
    </div>
  </div>

  <!-- Chat Body -->
  <div
    class="flex-1 overflow-y-auto flex flex-col px-[35px] pb-[35px] pt-5"
    #chatContainer
  >
    <div *ngIf="chatPartner" class="w-full flex flex-col gap-6 min-h-full">
      <!-- Push the messages block to the bottom when there's not enough content to scroll -->
      <div class="mt-auto"></div>

      <ng-container *ngIf="messages$ | async as msgs">
        <!-- Placeholder when no messages yet -->
        <div *ngIf="msgs.length === 0" class="p-4 text-center text-gray-500">
          Noch keine Nachrichten , sag Hallo und starte das Gespräch!
        </div>

        <ng-container *ngFor="let msg of msgs; let i = index">
          <!-- ── date separator when first message or new day ─────────── -->
          <div
            *ngIf="
              msg.createdAt &&
              (i === 0 ||
                (msgs[i - 1]?.createdAt &&
                  !sameDay(
                    msgs[i - 1].createdAt.toDate(),
                    msg.createdAt.toDate()
                  )))
            "
            class="flex items-center my-4"
          >
            <div class="flex-grow h-px bg-[#ADB0D9]"></div>
            <span
              class="bg-white px-4 py-1 text-base rounded-full border border-[#ADB0D9]"
            >
              {{ getSeparatorLabel(msg.createdAt.toDate()) }}
            </span>
            <div class="flex-grow h-px bg-[#ADB0D9]"></div>
          </div>

          <div
            class="flex my-4 gap-[30px] px-[10px]"
            [ngClass]="{
              'justify-end': msg.sender === currentUserUid,
              'items-start': msg.sender !== currentUserUid
            }"
          >
            <img
              *ngIf="msg.sender !== currentUserUid"
              [src]="participantsMap[msg.sender].avatar"
              alt="{{ participantsMap[msg.sender].name }}"
              class="w-[70px] h-[70px] rounded-full"
            />

            <div
              class="flex flex-col max-w-[80%] gap-1"
              [ngClass]="{
                'items-end': msg.sender === currentUserUid,
                'items-start': msg.sender !== currentUserUid
              }"
            >
              <div
                class="flex items-center gap-5"
                [ngClass]="{
                  'flex-row-reverse': msg.sender === currentUserUid
                }"
              >
                <span class="font-bold text-lg">
                  {{ participantsMap[msg.sender].name }}
                </span>
                <span
                  *ngIf="msg.createdAt"
                  class="text-[#686868] font-normal text-sm"
                >
                  {{ msg.createdAt.toDate() | date : "HH:mm" }} Uhr
                </span>
              </div>
              <div
                class="p-[15px] text-base"
                [ngClass]="
                  msg.sender === currentUserUid
                    ? 'bg-[#797EF3] text-white rounded-b-[30px] rounded-tl-[30px]'
                    : 'bg-[#ECEEFE] text-black rounded-b-[30px] rounded-tr-[30px]'
                "
              >
                {{ msg.text }}
              </div>
            </div>

            <img
              *ngIf="msg.sender === currentUserUid"
              [src]="participantsMap[msg.sender].avatar"
              alt="{{ participantsMap[msg.sender].name }}"
              class="w-[70px] h-[70px] rounded-full"
            />
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- fallback if no chatPartner… -->
    <div *ngIf="!chatPartner" class="flex-1 flex items-center justify-center">
      Wähle einen Chat aus.
    </div>
  </div>

  <!-- Input Field -->
  <div class="px-[35px] pb-[35px] pt-[15px] bg-transparent">
    <div
      class="flex flex-col p-5 border border-[#ADB0D9] rounded-[20px] gap-[20px]"
    >
      <!-- Textarea at top -->
      <textarea
        [(ngModel)]="newMessage"
        (keyup.enter)="send()"
        [disabled]="!chatPartner"
        placeholder="Nachricht an #Entwicklerteam"
        class="w-full resize-none border-none focus:outline-none text-lg placeholder-[#686868] bg-transparent pr-[30px]"
      ></textarea>

      <!-- Icon row at bottom -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-1">
          <button class="p-2">
            <img
              src="../../../assets/img/icons/sentiment_satisfied.png"
              class="w-6 h-6"
              alt="emoji"
            />
          </button>
          <button class="p-2">
            <img
              src="../../../assets/img/icons/alternate_email.png"
              class="w-6 h-6"
              alt="attachment"
            />
          </button>
        </div>
        <button (click)="send()" [disabled]="!newMessage.trim()" class="p-2">
          <img
            src="../../../assets/img/icons/send.png"
            class="w-6 h-6"
            alt="send"
          />
        </button>
      </div>
    </div>
  </div>
</div>
